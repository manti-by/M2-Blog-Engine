version: '3.3'
services:

  postgres:
    image: postgres:latest
    container_name: manti-by-postgres
    restart: always
    environment:
      - POSTGRES_DB=manti_by
      - POSTGRES_USER=manti_by
      - POSTGRES_PASSWORD=manti_by
    logging:
      driver: "none"

  redis:
    image: redis:latest
    container_name: manti-by-redis
    restart: always
    logging:
      driver: "none"

  django:
    image: mantiby/manti.by:latest
    container_name: manti-by-django
    restart: always
    ports:
      - 8080:8080
    links:
      - postgres
      - redis
    environment:
      - DJANGO_SETTINGS_MODULE=manti_by.settings.prod
    volumes:
      - /home/manti/www/manti.by/src/manti_by/:/srv/manti.by/src/
      - /mnt/nostromo/manti.by/log/:/var/log/manti.by/
      - /mnt/nostromo/manti.by/static/:/var/lib/manti.by/static/
      - /mnt/nostromo/manti.by/content/:/var/lib/manti.by/content/
    command: |
      gunicorn manti_by.wsgi:application -w 2 -b 0.0.0.0:8080 --log-file /var/log/manti.by/wsgi.log

  worker:
    image: mantiby/manti.by:latest
    container_name: manti-by-worker
    restart: always
    links:
      - postgres
      - redis
    environment:
      - DJANGO_SETTINGS_MODULE=manti_by.settings.prod
    volumes:
      - /home/manti/www/manti.by/src/manti_by/:/srv/manti.by/src/
      - /mnt/nostromo/manti.by/log/:/var/log/manti.by/
      - /mnt/nostromo/manti.by/content/:/var/lib/manti.by/content/
    command: |
      python manage.py rqworker default
